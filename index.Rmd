---
title: "COVID-19 ZA"
output: 
  flexdashboard::flex_dashboard:
    self_contained: false
    orientation: rows
    vertical_layout: scroll
    navbar:
      - { title: "painblogR", href: "https://www.painblogr.org", align: right }
    social: [ "twitter", "facebook", "menu" ]
    source_code: "https://github.com/kamermanpr/covid_19_dashboard.git"
---

<style type="text/css">

.chart-title {
  border-bottom: 1px solid #d7d7d7;
  color: #000000;
  font-size: 20px;
  font-weight: 300;
  padding: 7px 10px 4px;
}

</style>

```{r setup, include = FALSE}
# Load libraries
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(sf)
library(ggiraph)
library(plotly)

# Import data
## ZA
data <- read_csv('https://raw.githubusercontent.com/kamermanpr/covid_19_dataZA/master/data.csv')

## World
data_jhu <- read_csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv')

## US extra (missing early data from JHU)
### (No longer needed, JHU updated records)
#data_us <- read_csv('https://raw.githubusercontent.com/kamermanpr/covid_19_dashboard/master/data/us-2020-01-21-to-2020-03-09.csv')

# knitr options
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

Row {data-height=150}
----------

Welcome to my site, which gives updates on the state of COVID-19 cases and deaths in South Africa. These data are updated daily based on data released by the [National Institute of Communicable Diseases](http://www.nicd.ac.za/){target="_blank"}, and [Johns Hopkins University Coronavirus Resource Center](https://coronavirus.jhu.edu/map.html){target="_blank"}. For the moment, the site reports on: i) the cumulative number of cases in the South Africa and each of its provinces (top left panel), ii) the number of new cases per day in South Africa, by province (top right panel), iii) the cumulative number of cases per 100 000 population in South Africa and 6 other countries (bottom left panel), and the total number of new cases per day for the country as a whole (bottom right panel).<br><br>**Note:** These data in no way reflect the prevalence of the disease. Moreover, because testing densities and strategies differ between locales, direct comparisons between countries is fraught. . 

Row
----------

### Total cases

```{r}
if(data$date[[nrow(data)]] == Sys.Date()) {
  cases <- data %>% 
    filter(date == Sys.Date()) %>% 
    summarise(total = sum(n_cases, na.rm = TRUE)) %>%
    .$total
} else {
  cases <- data %>% 
    filter(date == Sys.Date() - 1) %>% 
    summarise(total = sum(n_cases, na.rm = TRUE)) %>%
    .$total
}

valueBox(cases, 
         icon = "fa-stethoscope")
```

### Compound daily growth

```{r}
rate <- data %>% 
  group_by(date) %>% 
  summarise(total = sum(n_cases, na.rm = TRUE))

time_period = 1/(nrow(rate) - 1)
first_value = first(rate$total)
last_value = last(rate$total)

cdgr <- round(100 * (((last_value / first_value)^time_period) -1))

valueBox(paste0(cdgr, '%'), 
         icon = "fa-chart-line")

```

### Total deaths

```{r}
if(data$date[[nrow(data)]] == Sys.Date()) {
  deaths <- data %>% 
    filter(date == Sys.Date()) %>% 
    summarise(total = sum(n_deaths, na.rm = TRUE)) %>%
    .$total
} else {
  deaths <- data %>% 
    filter(date == Sys.Date() - 1) %>% 
    summarise(total = sum(n_deaths, na.rm = TRUE)) %>%
    .$total
}

valueBox(deaths, 
         icon = "fa-sad-tear", 
         color = "#CC0000")
```

### Total recoveries

```{r}
if(data$date[[nrow(data)]] == Sys.Date()) {
  recover <- data %>% 
    filter(date == Sys.Date()) %>% 
    summarise(total = sum(n_recoveries, na.rm = TRUE)) %>%
    .$total
} else {
  recover <- data %>% 
    filter(date == Sys.Date() - 1) %>% 
    summarise(total = sum(n_recoveries, na.rm = TRUE)) %>%
    .$total
}

valueBox(recover, 
         icon = "fa-smile", 
         color = "green")
```


```{r eval = FALSE}
### Total tests
if(data$date[[nrow(data)]] == Sys.Date()) {
  tests <- data %>% 
    filter(date == Sys.Date()) %>% 
    .$n_tests %>% 
    unique(.)
} else {
  tests <- data %>% 
    filter(date == Sys.Date() - 1) %>% 
    .$n_tests %>% 
    unique(.)
}

valueBox(tests, 
         icon = "fa-notes-medical")
```

Row
----------

### Cumulative number of cases over time

```{r}
# Calculate total cases per date
data_totals <- data %>% 
    group_by(date) %>% 
    summarise(total = sum(n_cases, na.rm = TRUE)) 

## Fix dates with missing 'unknown' row
unknown_missing <- data %>% 
  filter(date < as_date('2020-03-23')) %>% 
  add_row(date = as_date('2020-03-22'),
          provinces = 'Unknown',
          n_tests = NA,
          n_cases = NA,
          n_deaths = NA,
          n_recoveries = NA) %>% 
  left_join(data_totals) %>% 
  complete(date, provinces, fill = list(n_cases = 0, 
                                          n_deaths = 0,
                                          n_recoveries = 0)) %>% 
  fill(n_tests, total, .direction = 'down') %>% 
  select(date, provinces, n_cases, total) %>% 
    pivot_wider(names_from = 'provinces',
                values_from = 'n_cases') 

## Get dates with 'unknown' row
unknown_present <- data %>% 
  filter(date > as_date('2020-03-22')) %>% 
  left_join(data_totals) %>% 
  select(date, provinces, n_cases, total) %>% 
    pivot_wider(names_from = 'provinces',
                values_from = 'n_cases') 

## Combine the two dataframes
data_cases_wide <- bind_rows(unknown_missing, unknown_present)

# Plot the data using plotly
## (damn I hate plotly's api)
data_cases_wide %>%     
    plot_ly(x = ~date, 
            y = ~total, 
            name = 'Total',
            type = 'scatter', 
            mode = 'lines+markers',
            marker = list(size = 10),
            hovertemplate = paste("<b>Date: </b>%{x}<br><b>Cases: <b>%{y}")) %>% 
    layout(font = list(family = 'Arial'),
           xaxis = list(title = 'Date',
                        titlefont = list(size = 20), 
                        nticks = nrow(data_cases_wide)),
           yaxis = list(title = 'Cumulative number of cases',
                        titlefont = list(size = 20))) %>% 
    add_trace(y = ~EC, name = 'Eastern Cape', 
              visible = 'legendonly') %>% 
    add_trace(y = ~FS, name = 'Free State', 
              visible = 'legendonly') %>% 
    add_trace(y = ~GP, name = 'Gauteng', 
              visible = 'legendonly') %>% 
    add_trace(y = ~KZN, name = 'KwaZulu-Natal',
              visible = 'legendonly') %>% 
    add_trace(y = ~LP, name = 'Limpopo', 
              visible = 'legendonly') %>% 
    add_trace(y = ~MP, name = 'Mpumalanga', 
              visible = 'legendonly') %>% 
    add_trace(y = ~NW, name = 'North West', 
              visible = 'legendonly') %>% 
    add_trace(y = ~NC, name = 'Northern Cape', 
              visible = 'legendonly') %>% 
    add_trace(y = ~WC, name = 'Western Cape', 
              visible = 'legendonly') %>% 
    add_trace(y = ~Unknown, name = 'Unknown', 
              visible = 'legendonly')
```

### Daily count of new cases, by province {.no-padding}

```{r}
# Read shape file
za_map <- st_read('data-shp/zaf_admin1.shp', quiet = TRUE)

# Simplify shapefile to a manageable size
za_map <- za_map %>%
    # Select columns
    select(ADM1_ID) %>%
    # Reduce size
    st_simplify(dTolerance = 0.03) 

# Simplify data to latest date
data_map <- data %>% 
  filter(date == max(date)) 

# Fix za_map admin_ID column
za_map <- za_map %>% 
  rename(provinces = ADM1_ID) %>% 
  mutate(provinces = as.character(provinces)) %>% 
  mutate(provinces = case_when(
    provinces == 'LIM' ~ 'LP',
    provinces == 'GT' ~ 'GP',
    TRUE ~ provinces
  )) %>% 
  # Join with map data
  left_join(data_map) %>% 
  arrange(provinces)

# Process data
za_map <- za_map %>% 
  # Filter out unknown
  filter(provinces != 'Unknown') %>% 
  # Add full province names
  mutate(province_names = case_when(
    provinces == 'WC' ~ 'Western Cape',
    provinces == 'EC' ~ 'Eastern Cape',
    provinces == 'NC' ~ 'Northern Cape',
    provinces == 'FS' ~ 'Free State',
    provinces == 'KZN' ~ 'KwaZulu-Natal',
    provinces == 'NW' ~ 'North West',
    provinces == 'GP' ~ 'Gauteng',
    provinces == 'MP' ~ 'Mpumalanga',
    provinces == 'LP' ~ 'Limpopo'
  )) 

date_past <- data %>% 
  filter(date != max(date)) %>% 
  filter(date == max(date)) %>% 
  arrange(provinces) %>% 
  select(provinces, n_cases) %>% 
  rename(n_cases24 = n_cases)

za_map <- za_map %>% 
  arrange(provinces) %>% 
  left_join(date_past) %>% 
  mutate(delta_cases = n_cases - n_cases24) %>% 
  # Add a tooltip
  mutate(tooltip = paste0('<b>', province_names, '</b><br>',
                          '<em>New cases: </em>', delta_cases, '<br>'))

# Generate plot object
gg_province <- ggplot(data = za_map) +
    geom_sf_interactive(aes(tooltip = tooltip,
                            fill = delta_cases), 
             color = '#000000',
             size = 0.25) +
    labs(title = str_glue('Date: {data$date[[nrow(data)]]}'),
         subtitle = 'Move cursor over each province to see province-specific data\nGrey fill indicates no data available') +
    scale_fill_distiller(name = 'New cases', 
                         direction = 1) +
    theme_void() +
    theme(panel.grid = element_line(colour = '#FFFFFF'),
          plot.caption = element_text(face = 'italic',
                                      hjust = 0))

girafe(ggobj = gg_province,
       options = list(opts_hover(css = 'cursor:pointer;fill:#FFFFFF;stroke:#FFFFFF;'),
                      opts_tooltip(css = 'background-color:#000000;font-family:sans-serif,arial;font-size:80%;color:#FFFFFF;padding:10px;border-radius:10px 10px 10px 10px;'),
                      opts_sizing(width = 0.67)))
```

Row
----------

### Cases per 100,000 population

```{r}
# Select and filter data
data_jhu <- data_jhu %>% 
  rename(country = `Country/Region`) %>% 
  select(-Lat, -Long) %>% 
  filter(country %in% c('China', 'US', 'Brazil', 'France', 
                        'United Kingdom', 'Italy', 'South Africa'))

# Process data
## China
jhu_china <- data_jhu %>% 
  filter(country == 'China') %>% 
  select(-`Province/State`) %>% 
  summarise_if(is.numeric, sum) %>% 
  mutate(country = 'China') %>% 
  select(country, everything())  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'china_count') %>% 
  mutate(cum_sum = cumsum(china_count)) %>% 
  filter(cum_sum > 0) %>% 
  select(-cum_sum) %>% 
  mutate(days = row_number()) %>%
  mutate(china_count.100k = (china_count / 1439323766) * 100000) %>% 
  select(date, days, china_count, china_count.100k) %>% 
  mutate(china_count.100k = round(china_count.100k, 4)) %>% 
  select(-date)

## USA
jhu_us <- data_jhu %>% 
  filter(country == 'US') %>% 
  select(-`Province/State`) %>% 
  summarise_if(is.numeric, sum) %>% 
  mutate(country = 'US') %>% 
  select(country, everything())  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'us_count') %>%
  mutate(cum_sum = cumsum(us_count)) %>% 
  filter(cum_sum > 0) %>% 
  select(-cum_sum) %>% 
  mutate(days = row_number()) %>% 
  mutate(us_count.100k = (us_count / 331002651) * 100000) %>% 
  select(date, days, us_count, us_count.100k) %>% 
  mutate(us_count.100k = round(us_count.100k, 4)) %>% 
  select(-date)

## Brazil
jhu_brazil <- data_jhu %>% 
  filter(country == 'Brazil') %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'brazil_count') %>% 
  mutate(cum_sum = cumsum(brazil_count)) %>% 
  filter(cum_sum > 0) %>% 
  select(-cum_sum) %>% 
  mutate(days = row_number()) %>% 
  mutate(brazil_count.100k = (brazil_count / 212559417) * 100000) %>% 
  select(date, days, brazil_count, brazil_count.100k) %>% 
  mutate(brazil_count.100k = round(brazil_count.100k, 4)) %>% 
  select(-date)

jhu_france <- data_jhu %>% 
  filter(country == 'France') %>% 
  filter(is.na(`Province/State`)) %>% 
  select(-`Province/State`) %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'france_count') %>% 
  mutate(cum_sum = cumsum(france_count)) %>% 
  filter(cum_sum > 0) %>% 
  select(-cum_sum) %>% 
  mutate(days = row_number()) %>% 
  mutate(france_count.100k = (france_count / 65273511) * 100000) %>% 
  select(date, days, france_count, france_count.100k) %>% 
  mutate(france_count.100k = round(france_count.100k, 4)) %>% 
  select(-date)

## United Kingdom
jhu_uk <- data_jhu %>% 
  filter(country == 'United Kingdom') %>% 
  filter(is.na(`Province/State`)) %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'uk_count') %>% 
  mutate(cum_sum = cumsum(uk_count)) %>% 
  filter(cum_sum > 0) %>% 
  select(-cum_sum) %>%  
  mutate(days = row_number()) %>% 
  mutate(uk_count.100k = (uk_count / 67886011) * 100000) %>% 
  select(date, days, uk_count, uk_count.100k) %>% 
  mutate(uk_count.100k = round(uk_count.100k, 4)) %>% 
  select(-date)

## Italy
jhu_italy <- data_jhu %>% 
  filter(country == 'Italy') %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'italy_count') %>% 
  mutate(cum_sum = cumsum(italy_count)) %>% 
  filter(cum_sum > 0) %>% 
  select(-cum_sum) %>%  
  mutate(days = row_number()) %>% 
  mutate(italy_count.100k = (italy_count / 60461826) * 100000) %>% 
  select(date, days, italy_count, italy_count.100k) %>% 
  mutate(italy_count.100k = round(italy_count.100k, 4)) %>% 
  select(-date)

## South Africa
jhu_za <- data_jhu %>% 
  filter(country == 'South Africa') %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'za_count') %>% 
  mutate(cum_sum = cumsum(za_count)) %>% 
  filter(cum_sum > 0) %>% 
  select(-cum_sum) %>% 
  mutate(days = row_number()) %>% 
  mutate(za_count.100k = (za_count / 59308690) * 100000) %>% 
  select(date, days, za_count, za_count.100k) %>% 
  mutate(za_count.100k = round(za_count.100k, 4)) %>% 
  select(-date)

# Bind columns
data_jhu2 <- jhu_china %>% 
  left_join(jhu_us) %>% 
  left_join(jhu_brazil) %>% 
  left_join(jhu_france) %>% 
  left_join(jhu_italy) %>% 
  left_join(jhu_uk) %>% 
  left_join(jhu_za) 

# Plot
plot_ly(data = data_jhu2,
        x = ~days,
        y = ~za_count.100k,
        name = 'South Africa',
        type = 'scatter',
        marker = list(size = 10),
        mode = 'lines+markers',
        hovertemplate = paste("<b>Days since first case(s): </b>%{x}<br><b>Cases/100,000 pop: <b>%{y}")) %>% 
    layout(font = list(family = 'Arial'),
           xaxis = list(title = 'Days since first reported cases',
                        titlefont = list(size = 20)),
           yaxis = list(title = 'Cumulative cases per 100,000 people',
                        titlefont = list(size = 20))) %>% 
  add_trace(y = ~brazil_count.100k,
            name = 'Brazil',
            visible = 'legendonly') %>% 
  add_trace(y = ~china_count.100k,
            name = 'China',
            visible = 'legendonly') %>% 
  add_trace(y = ~france_count.100k,
            name = 'France',
            visible = 'legendonly') %>% 
  add_trace(y = ~italy_count.100k,
            name = 'Italy',
            visible = 'legendonly') %>% 
  add_trace(y = ~uk_count.100k,
            name = 'UK',
            visible = 'legendonly') %>% 
  add_trace(y = ~us_count.100k,
            name = 'USA',
            visible = 'legendonly')
```

### Daily count of new cases and recoveries, for the country

```{r}
# Calculate cumulative totals
data_daily <- data %>% 
  select(date, n_cases, n_deaths, n_recoveries) %>% 
  group_by(date) %>% 
  summarise(n_cases = sum(n_cases, na.rm = TRUE),
            n_deaths = sum(n_deaths, na.rm = TRUE),
            n_recoveries = sum(n_recoveries, na.rm = TRUE)) %>% 
  ungroup()

# Top slice the first row of data
top_slice <- data_daily %>% 
  filter(date == '2020-3-12') 

# Calculate daily totals 
data_daily <- data_daily %>% 
  mutate(n_cases = n_cases - lag(n_cases),
         n_deaths = n_deaths - lag(n_deaths),
         n_recoveries = n_recoveries - lag(n_recoveries)) %>% 
  filter(date != '2020-03-12') %>% 
  # Add back the top sliced data
  bind_rows(top_slice) %>% 
  arrange(date) %>% 
  mutate(date = as.Date(date)) %>% 
  # Remove negative n_recoveries values
  mutate(n_recoveries = ifelse(n_recoveries < 0,
                               yes = 0,
                               no = n_recoveries)) 
# Plot
plot_ly(data = data_daily,
       x = ~date,
       y = ~n_cases,
       type = 'bar', 
       name = 'Cases', 
       hovertemplate = paste("<b>Date: </b>%{x}<br><b>Cases: <b>%{y}"),
       marker = list(color = 'rgb(49,130,189)',
                     size = 10)) %>% 
  layout(font = list(family = 'Arial'),
           xaxis = list(title = 'Date',
                        titlefont = list(size = 20), 
                        nticks = nrow(data_daily)),
           yaxis = list(title = 'Daily count',
                        titlefont = list(size = 20))) %>% 
  add_trace(y = ~n_recoveries, 
            name = 'Recoveries', 
            hovertemplate = paste("<b>Date: </b>%{x}<br><b>Recoveries: <b>%{y}"),
            marker = list(color = 'rgb(204,204,204)'),
            visible = 'legendonly')
```

```{r eval = FALSE}
# Row 
# ----------
# ### Proportion of cases resulting in death

# Process data
perc_deaths <- data %>% 
  select(-provinces, -n_tests) %>% 
  group_by(date) %>% 
  summarise(total_cases = sum(n_cases),
            total_deaths = sum(n_deaths),
            percent = round(100 * (total_deaths/total_cases), 2)) 

# Plot the data using plotly
perc_deaths %>%     
    plot_ly(x = ~date, 
            y = ~percent, 
            name = 'deaths',
            type = 'scatter', 
            mode = 'lines+markers',
            marker = list(size = 10),
            hovertemplate = paste("<b>Date: </b>%{x}<br><b>Percent deaths: <b>%{y}%")) %>% 
    layout(xaxis = list(title = 'Date',
                        titlefont = list(size = 20), 
                        tickformat = '%Y-%m-%d',
                        nticks = nrow(pos_tests)),
           yaxis = list(title = 'Percent cases resulting in death (%)',
                        titlefont = list(size = 20),
                        range = c(0, 5))) 
```

```{r eval = FALSE}
# Row 
# ----------
# ### Proportion of positive tests

# Process data
perc_tests <- data %>% 
  select(-provinces, -n_deaths) %>% 
  group_by(date, n_tests) %>% 
  summarise(total_cases = sum(n_cases)) %>% 
  ungroup() %>% 
  mutate(percent = round(100 * (total_cases / n_tests), 2))

# Plot the data using plotly
perc_tests %>%     
    plot_ly(x = ~date, 
            y = ~percent, 
            name = 'tests',
            type = 'scatter', 
            mode = 'lines+markers',
            marker = list(size = 10),
            hovertemplate = paste("<b>Date: </b>%{x}<br><b>Percent positive: <b>%{y}%")) %>% 
    layout(xaxis = list(title = 'Date',
                        titlefont = list(size = 20), 
                        tickformat = '%Y-%m-%d',
                        nticks = nrow(perc_tests)),
           yaxis = list(title = 'Percent positive tests (%)',
                        titlefont = list(size = 20))) 
```