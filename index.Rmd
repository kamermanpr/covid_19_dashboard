---
title: "COVID-19 ZA"
output: 
  flexdashboard::flex_dashboard:
    self_contained: false
    orientation: rows
    vertical_layout: scroll
    navbar:
      - { title: "painblogR", href: "https://www.painblogr.org", align: right }
    social: [ "twitter", "facebook", "menu" ]
    source_code: "https://github.com/kamermanpr/covid_19_dashboard.git"
---

<style type="text/css">

.chart-title {
  border-bottom: 1px solid #d7d7d7;
  color: #000000;
  font-size: 20px;
  font-weight: 300;
  padding: 7px 10px 4px;
}

</style>

```{r setup, include = FALSE}
# Load libraries
library(flexdashboard)
library(tidyverse)
library(sf)
library(ggiraph)
library(plotly)

# Import data
## ZA
data <- read_csv('https://raw.githubusercontent.com/kamermanpr/covid_19_dataZA/master/data.csv')

## World
data_jhu <- read_csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv')

# knitr options
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

Row {data-height=70}
----------

Welcome to my site, which gives updates on the state of COVID-19 cases and deaths in South Africa. These data are updated daily based on data released by the [National Institute of Communicable Diseases](http://www.nicd.ac.za/){target="_blank"}, and [Johns Hopkins University Coronavirus Resource Center](https://coronavirus.jhu.edu/map.html){target="_blank"}. For the moment, the site reports on: i) the cumulative number of cases in the South Africa and each of its provinces (top left panel), ii) the number of new cases per day in South Africa, by province (top right panel), and iii) the number of cases per 100 000 population in South Africa and 6 other countries (bottom left panel).

Row
----------

### Cumulative number of cases

```{r}
if(data$date[[nrow(data)]] == Sys.Date()) {
  cases <- data %>% 
    filter(date == Sys.Date()) %>% 
    summarise(total = sum(n_cases)) %>%
    .$total
} else {
  cases <- data %>% 
    filter(date == Sys.Date() - 1) %>% 
    summarise(total = sum(n_cases)) %>%
    .$total
}

valueBox(cases, 
         icon = "fa-stethoscope",
         color = ifelse(cases > 100, 
                        yes = "warning", 
                        no = "primary"))
```

### Total number of tests

```{r}
if(data$date[[nrow(data)]] == Sys.Date()) {
  tests <- data %>% 
    filter(date == Sys.Date()) %>% 
    .$n_tests %>% 
    unique(.)
} else {
  tests <- data %>% 
    filter(date == Sys.Date() - 1) %>% 
    .$n_tests %>% 
    unique(.)
}

valueBox(tests, 
         icon = "fa-notes-medical")
```

### Cumulative number of deaths

```{r}
if(data$date[[nrow(data)]] == Sys.Date()) {
  deaths <- data %>% 
    filter(date == Sys.Date()) %>% 
    summarise(total = sum(n_deaths)) %>%
    .$total
} else {
  deaths <- data %>% 
    filter(date == Sys.Date() - 1) %>% 
    summarise(total = sum(n_deaths)) %>%
    .$total
}

valueBox(deaths, 
         icon = "fa-sad-tear", 
         color = ifelse(deaths > 0, 
                        yes = "danger", 
                        no = "primary"))
```


Row
----------

### Cumulative number of cases over time

```{r}
# Calculate total cases per date
foo <- data %>% 
    group_by(date) %>% 
    summarise(total = sum(n_cases)) 

# Add total cases as a column and pivot provinces to wide format
data_wide <- data %>% 
    left_join(foo) %>% 
    pivot_wider(names_from = 'provinces',
                values_from = 'n_cases') %>% 
    mutate(date = as.Date(date, format = '%Y-%m-%d'))

# Plot the data using plotly
## (damn I hate plotly's api)
data_wide %>%     
    plot_ly(x = ~date, 
            y = ~total, 
            name = 'Total',
            type = 'scatter', 
            mode = 'lines+markers',
            marker = list(size = 10),
            hovertemplate = paste("<b>Date: </b>%{x}<br><b>Cases: <b>%{y}")) %>% 
    layout(font = list(family = 'Arial'),
           xaxis = list(title = 'Date',
                        titlefont = list(size = 20), 
                        nticks = nrow(data_wide)),
           yaxis = list(title = 'Cumulative number of cases',
                        titlefont = list(size = 20))) %>% 
    add_trace(y = ~FS, name = 'Free State', 
              visible = 'legendonly') %>% 
    add_trace(y = ~EC, name = 'Eastern Cape', 
              visible = 'legendonly') %>% 
    add_trace(y = ~GP, name = 'Gauteng', 
              visible = 'legendonly') %>% 
    add_trace(y = ~KZN, name = 'KwaZulu-Natal',
              visible = 'legendonly') %>% 
    add_trace(y = ~LP, name = 'Limpopo', 
              visible = 'legendonly') %>% 
    add_trace(y = ~MP, name = 'Mpumalanga', 
              visible = 'legendonly') %>% 
    add_trace(y = ~NW, name = 'North West', 
              visible = 'legendonly') %>% 
    add_trace(y = ~NC, name = 'Northern Cape', 
              visible = 'legendonly') %>% 
    add_trace(y = ~WC, name = 'Western Cape', 
              visible = 'legendonly')
```

### Number of new cases in the last 24-hours, by province {.no-padding}

```{r}
# Read shape file
za_map <- st_read('data-shp/zaf_admin1.shp', quiet = TRUE)

# Simplify shapefile to a managable size
za_map <- za_map %>%
    # Select columns
    select(ADM1_ID) %>%
    # Reduce size
    st_simplify(dTolerance = 0.03) 

# Simplify data to latest date
data_map <- data %>% 
  filter(date == max(date)) 

# Fix za_map admin_ID column
za_map <- za_map %>% 
  rename(provinces = ADM1_ID) %>% 
  mutate(provinces = as.character(provinces)) %>% 
  mutate(provinces = case_when(
    provinces == 'LIM' ~ 'LP',
    provinces == 'GT' ~ 'GP',
    TRUE ~ provinces
  )) %>% 
  # Join with map data
  left_join(data_map) %>% 
  arrange(provinces)

# Process data
za_map <- za_map %>% 
  # Add full province names
  mutate(province_names = case_when(
    provinces == 'WC' ~ 'Western Cape',
    provinces == 'EC' ~ 'Eastern Cape',
    provinces == 'NC' ~ 'Northern Cape',
    provinces == 'FS' ~ 'Free State',
    provinces == 'KZN' ~ 'KwaZulu-Natal',
    provinces == 'NW' ~ 'North West',
    provinces == 'GP' ~ 'Gauteng',
    provinces == 'MP' ~ 'Mpumalanga',
    provinces == 'LP' ~ 'Limpopo'
  )) 

bar <- data %>% 
  filter(date != max(date)) %>% 
  filter(date == max(date)) %>% 
  arrange(provinces) %>% 
  select(provinces, n_cases) %>% 
  rename(n_cases24 = n_cases)

za_map <- za_map %>% 
  arrange(provinces) %>% 
  left_join(bar) %>% 
  mutate(delta_cases = n_cases - n_cases24) %>% 
  # Add a tooltip
  mutate(tooltip = paste0('<b>', province_names, '</b><br>',
                          '<em>New cases: </em>', delta_cases, '<br>'))

# Generate plot object
gg_province <- ggplot(data = za_map) +
    geom_sf_interactive(aes(tooltip = tooltip,
                            fill = delta_cases), 
             color = '#000000',
             size = 0.25) +
    labs(subtitle = str_glue('Date: {data$date[[nrow(data)]]}'),
         caption = '* Move cursor over each province to see province-specific data') +
    scale_fill_distiller(name = 'New cases', 
                         direction = 1) +
    theme_void() +
    theme(panel.grid = element_line(colour = '#FFFFFF'),
          plot.caption = element_text(face = 'italic',
                                      hjust = 0))

girafe(ggobj = gg_province,
       options = list(opts_hover(css = 'cursor:pointer;fill:#FFFFFF;stroke:#FFFFFF;'),
                      opts_tooltip(css = 'background-color:#000000;font-family:sans-serif,arial;font-size:80%;color:#FFFFFF;padding:10px;border-radius:10px 10px 10px 10px;'),
                      opts_sizing(width = 0.67)))
```

Row
----------

### Cases per 100,000 population

```{r}
# Select and filter data
data_jhu <- data_jhu %>% 
  rename(country = `Country/Region`) %>% 
  select(-Lat, -Long) %>% 
  filter(country %in% c('China', 'US', 'Brazil', 'France', 
                        'United Kingdom', 'Italy', 'South Africa'))

# Process data
## China
jhu_china <- data_jhu %>% 
  filter(country == 'China') %>% 
  select(-`Province/State`) %>% 
  summarise_if(is.numeric, sum) %>% 
  mutate(country = 'China') %>% 
  select(country, everything())  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'china_count') %>% 
  mutate(days = row_number()) %>% 
  mutate(china_count.100k = (china_count / 1439323766) * 100000) %>% 
  select(date, days, china_count, china_count.100k) %>% 
  mutate(china_count.100k = round(china_count.100k, 2))

## USA
jhu_us <- data_jhu %>% 
  filter(country == 'US') %>% 
  filter(`Province/State` %in% c('Alabama', 'Alaska', 'Arizona', 'Arkansas', 
                                 'California', 'Colorado', 'Connecticut', 
                                 'Delaware', 'Florida', 'Georgia', 'Hawaii', 
                                 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas',
                                 'Kentucky', 'Louisiana', 'Maine', 'Maryland',
                                 'Massachusetts', 'Michigan', 'Minnesota', 
                                 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 
                                 'Nevada', 'New Hampshire', 'New Jersey', 
                                 'New Mexico', 'New York', 'North Carolina', 
                                 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon',
                                 'Pennsylvania', 'Rhode Island', 'South Carolina', 
                                 'South Dakota', 'Tennessee', 'Texas', 'Utah', 
                                 'Vermont', 'Virginia', 'Washington', 
                                 'West Virginia', 'Wisconsin', 'Wyoming')) %>% 
  select(-`Province/State`) %>% 
  summarise_if(is.numeric, sum) %>% 
  mutate(country = 'US') %>% 
  select(country, everything())  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'us_count') %>% 
  mutate(days = row_number()) %>% 
  mutate(us_count.100k = (us_count / 331002651) * 100000) %>% 
  select(date, days, us_count, us_count.100k) %>% 
  mutate(us_count.100k = round(us_count.100k, 2))

## Brazil
jhu_brazil <- data_jhu %>% 
  filter(country == 'Brazil') %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'brazil_count') %>% 
  mutate(days = row_number()) %>% 
  mutate(brazil_count.100k = (brazil_count / 212559417) * 100000) %>% 
  select(date, days, brazil_count, brazil_count.100k) %>% 
  mutate(brazil_count.100k = round(brazil_count.100k, 2))

jhu_france <- data_jhu %>% 
  filter(country == 'France') %>% 
  filter(`Province/State` == 'France') %>% 
  select(-`Province/State`) %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'france_count') %>% 
  mutate(days = row_number()) %>% 
  mutate(france_count.100k = (france_count / 65273511) * 100000) %>% 
  select(date, days, france_count, france_count.100k) %>% 
  mutate(france_count.100k = round(france_count.100k, 2))

## United Kingdom
jhu_uk <- data_jhu %>% 
  filter(country == 'United Kingdom') %>% 
  filter(`Province/State` == 'United Kingdom') %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'uk_count') %>% 
  mutate(days = row_number()) %>% 
  mutate(uk_count.100k = (uk_count / 67886011) * 100000) %>% 
  select(date, days, uk_count, uk_count.100k) %>% 
  mutate(uk_count.100k = round(uk_count.100k, 2))

## Italy
jhu_italy <- data_jhu %>% 
  filter(country == 'Italy') %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'italy_count') %>% 
  mutate(days = row_number()) %>% 
  mutate(italy_count.100k = (italy_count / 60461826) * 100000) %>% 
  select(date, days, italy_count, italy_count.100k) %>% 
  mutate(italy_count.100k = round(italy_count.100k, 2))

## South Africa
jhu_za <- data_jhu %>% 
  filter(country == 'South Africa') %>% 
  select(-`Province/State`)  %>% 
  pivot_longer(cols = 2:(ncol(data_jhu)-1),
               names_to = 'date',
               values_to = 'za_count') %>% 
  mutate(days = row_number()) %>% 
  mutate(za_count.100k = (za_count / 59308690) * 100000) %>% 
  select(date, days, za_count, za_count.100k) %>% 
  mutate(za_count.100k = round(za_count.100k, 2))

# Bind columns
data_jhu2 <- jhu_china %>% 
  left_join(jhu_us) %>% 
  left_join(jhu_brazil) %>% 
  left_join(jhu_france) %>% 
  left_join(jhu_italy) %>% 
  left_join(jhu_uk) %>% 
  left_join(jhu_za) %>% 
  mutate(date = as.Date(date, format = '%m/%d/%y'))

# Plot
plot_ly(data = data_jhu2,
        x = ~date,
        y = ~za_count.100k,
        name = 'South Africa',
        type = 'scatter',
        mode = 'line',
        hovertemplate = paste("<b>Date: </b>%{x}<br><b>Cases/100,000 pop: <b>%{y}")) %>% 
    layout(font = list(family = 'Arial'),
           xaxis = list(title = 'Date',
                        titlefont = list(size = 20)),
           yaxis = list(title = 'Cases per 100,000 population',
                        titlefont = list(size = 20))) %>% 
  add_trace(y = ~brazil_count.100k,
            name = 'Brazil',
            visible = 'legendonly') %>% 
  add_trace(y = ~china_count.100k,
            name = 'China',
            visible = 'legendonly') %>% 
  add_trace(y = ~france_count.100k,
            name = 'France',
            visible = 'legendonly') %>% 
  add_trace(y = ~italy_count.100k,
            name = 'Italy',
            visible = 'legendonly') %>% 
  add_trace(y = ~uk_count.100k,
            name = 'UK',
            visible = 'legendonly') %>% 
  add_trace(y = ~us_count.100k,
            name = 'USA',
            visible = 'legendonly')
```

###

```{r eval = FALSE}
# Row 
# ----------
# ### Proportion of cases resulting in death

# Process data
perc_deaths <- data %>% 
  select(-provinces, -n_tests) %>% 
  group_by(date) %>% 
  summarise(total_cases = sum(n_cases),
            total_deaths = sum(n_deaths),
            percent = round(100 * (total_deaths/total_cases), 2)) 

# Plot the data using plotly
perc_deaths %>%     
    plot_ly(x = ~date, 
            y = ~percent, 
            name = 'deaths',
            type = 'scatter', 
            mode = 'lines+markers',
            marker = list(size = 10),
            hovertemplate = paste("<b>Date: </b>%{x}<br><b>Percent deaths: <b>%{y}%")) %>% 
    layout(xaxis = list(title = 'Date',
                        titlefont = list(size = 20), 
                        tickformat = '%Y-%m-%d',
                        nticks = nrow(pos_tests)),
           yaxis = list(title = 'Percent cases resulting in death (%)',
                        titlefont = list(size = 20),
                        range = c(0, 5))) 
```

```{r eval = FALSE}
# Row 
# ----------
# ### Proportion of positive tests

# Process data
perc_tests <- data %>% 
  select(-provinces, -n_deaths) %>% 
  group_by(date, n_tests) %>% 
  summarise(total_cases = sum(n_cases)) %>% 
  ungroup() %>% 
  mutate(percent = round(100 * (total_cases / n_tests), 2))

# Plot the data using plotly
perc_tests %>%     
    plot_ly(x = ~date, 
            y = ~percent, 
            name = 'tests',
            type = 'scatter', 
            mode = 'lines+markers',
            marker = list(size = 10),
            hovertemplate = paste("<b>Date: </b>%{x}<br><b>Percent positive: <b>%{y}%")) %>% 
    layout(xaxis = list(title = 'Date',
                        titlefont = list(size = 20), 
                        tickformat = '%Y-%m-%d',
                        nticks = nrow(pos_tests)),
           yaxis = list(title = 'Percent positive tests (%)',
                        titlefont = list(size = 20))) 
```